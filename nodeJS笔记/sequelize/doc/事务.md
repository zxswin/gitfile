# Transactions - 事务

## 托管事务（auto-callback）
* 托管事务自动处理提交或回滚事务。
* 如果返回链中的所有 promise 都已成功解决，则事务被提交。
* 如果一个或几个 promise 被拒绝，事务将回滚。

``` js
/** 要自动将事务传递给所有查询，您必须安装 continuation local storage (CLS) 模块，
 * 并在您自己的代码中实例化一个命名空间：
 * */
const cls = require("continuation-local-storage"),
  namespace = cls.createNamespace("my-very-own-namespace");

/** 建立连接  */
const Sequelize = require("sequelize");

/** 使用 (CLS) 模块  */
Sequelize.useCLS(namespace);

/** 引入OP对象  */
const Op = Sequelize.Op;
const sequelize = new Sequelize("tsequelize", "root", "123456", {
  host: "localhost",
  dialect: "mysql",
  operatorsAliases: false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000
  },
  timezone: "+08:00" // 设置时间为东八区时间
});

(async () => {
  /** 建立模型  */
  const User = sequelize.define("user", {
    firstName: {
      type: Sequelize.STRING
    },
    lastName: {
      type: Sequelize.STRING
    }
  });

  /** 强制创建表 */
  await sequelize.sync({ force: true });

  sequelize.transaction((t) => {
    return User.create(
      {
        firstName: "Abraham",
        lastName: "Lincoln"
      },
      { transaction: t }
    ).then(user => {
      // 查询成功，但我们仍然想回滚！
      console.log('事务已经成功提交');
    }).catch(err=>{
      console.log('事务回滚');
    });
  });

})();
```


## 非托管事务（then-callback）
* 非托管事务强制您手动回滚或提交交易。 如果不这样做，事务将挂起，直到超时。
``` js
sequelize.transaction().then(function(t) {
  return User.create(
    {
      firstName: "Bart",
      lastName: "Simpson"
    },
    { transaction: t }
  )
    .then(function(user) {
      return user.addSibling(
        {
          firstName: "Lisa",
          lastName: "Simpson"
        },
        { transaction: t }
      );
    })
    .then(function() {
      return t.commit();
    })
    .catch(function(err) {
      return t.rollback(); // 将会回滚
    });
});
```


## 隔离级别
* 默认情况下，sequelize 使用数据库的隔离级别。 
``` js
// 全局设置
new Sequelize('db', 'user', 'pw', {
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
});

// 局部设置
sequelize.transaction({
  isolationLevel: Sequelize.Transaction.ISOLATION_LEVELS.SERIALIZABLE
});
```




## 单词
``` bash
transaction  交易 事务
tedious 乏味的
deferrable 可推迟的
```