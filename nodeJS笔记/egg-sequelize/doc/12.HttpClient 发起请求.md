# 12.HttpClient 发起请求

- 框架基于 urllib 内置实现了一个 HttpClient，应用可以非常便捷地完成任何 HTTP 请求

## app.curl 方法完成一次 HTTP 请求

- app.curl(url, options) 方法，它等价于 app.httpclient.request(url, options)

```js
// app.js
module.exports = app => {
  app.beforeStart(async () => {
    // 示例：启动的时候去读取 https://registry.npm.taobao.org/egg/latest 的版本信息
    const result = await app.curl(
      'https://registry.npm.taobao.org/egg/latest',
      {
        dataType: 'json'
      }
    );
    app.logger.info('Egg latest version: %s', result.data.version);
  });
};
```

## 通过 ctx 使用 HttpClient

- context 中同样提供了 ctx.curl(url, options) 和 ctx.httpclient

```js
// app/controller/npm.js
class NpmController extends Controller {
  async index() {
    const ctx = this.ctx;

    // 示例：请求一个 npm 模块信息
    const result = await ctx.curl(
      'https://registry.npm.taobao.org/egg/latest',
      {
        // 自动解析 JSON response
        dataType: 'json',
        // 3 秒超时
        timeout: 3000
      }
    );

    ctx.body = {
      status: result.status,
      headers: result.headers,
      package: result.data
    };
  }
}
```

## 进行网络请求案例

### GET 请求案例

- HttpClient 的默认 method 会设置为 GET
- 返回值 result 会包含 3 个属性：status, headers 和 data
  status: 响应状态码，如 200, 302, 404, 500 等等
  headers: 响应头，类似 { 'content-type': 'text/html', ... }
  data: 响应 body，默认 HttpClient 不会做任何处理，会直接返回 Buffer 类型数据。
  一旦设置了 options.dataType，HttpClient 将会根据此参数对 data 进行相应的处理。

```js
// app/controller/npm.js
class NpmController extends Controller {
  async get() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/get?foo=bar');
    ctx.status = result.status;
    ctx.set(result.headers);
    ctx.body = result.data;
  }
}
```

### POST 请求案例

```js
// app/controller/npm.js
class NpmController extends Controller {
  async post() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/post', {
      // 必须指定 method
      method: 'POST',
      // 通过 contentType 告诉 HttpClient 以 JSON 格式发送
      contentType: 'json',
      data: {
        hello: 'world',
        now: Date.now()
      },
      // 明确告诉 HttpClient 以 JSON 格式处理返回的响应 body
      dataType: 'json'
    });
    ctx.body = result.data;
  }
}
```

### PUT 请求案例

```js
// app/controller/npm.js
class NpmController extends Controller {
  async put() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/put', {
      // 必须指定 method
      method: 'PUT',
      // 通过 contentType 告诉 HttpClient 以 JSON 格式发送
      contentType: 'json',
      data: {
        update: 'foo bar'
      },
      // 明确告诉 HttpClient 以 JSON 格式处理响应 body
      dataType: 'json'
    });
    ctx.body = result.data;
  }
}
```

### DELETE 请求案例

```js
// app/controller/npm.js
class NpmController extends Controller {
  async del() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/delete', {
      // 必须指定 method
      method: 'DELETE',
      // 明确告诉 HttpClient 以 JSON 格式处理响应 body
      dataType: 'json'
    });
    ctx.body = result.data;
  }
}
```

## 高级 HTTP 请求

### Form 表单提交

```js
// app/controller/npm.js
class NpmController extends Controller {
  async submit() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/post', {
      // 必须指定 method，支持 POST，PUT 和 DELETE
      method: 'POST',
      // 不需要设置 contentType，HttpClient 会默认以 application/x-www-form-urlencoded 格式发送请求
      data: {
        now: Date.now(),
        foo: 'bar'
      },
      // 明确告诉 HttpClient 以 JSON 格式处理响应 body
      dataType: 'json'
    });
    ctx.body = result.data.form;
    // 响应最终会是类似以下的结果：
    // {
    //   "foo": "bar",
    //   "now": "1483864184348"
    // }
  }
}
```

### 以 Multipart 方式上传文件

- 引入 formstream 这个第三方模块来帮助我们生成可以被 HttpClient 消费的 form 对象
- 你还可以继续通过 form.file() 添加更多文件以实现一次性上传多个文件的需求。
  form.file('file1', file1);
  form.file('file2', file2);

```js
// app/controller/npm.js
const FormStream = require('formstream');
class NpmController extends Controller {
  async upload() {
    const ctx = this.ctx;
    const form = new FormStream();
    // 设置普通的 key value
    form.field('foo', 'bar');
    // 上传当前文件本身用于测试
    form.file('file', __filename);

    const result = await ctx.curl('https://httpbin.org/post', {
      // 必须指定 method，支持 POST，PUT
      method: 'POST',
      // 生成符合 multipart/form-data 要求的请求 headers
      headers: form.headers(),
      // 以 stream 模式提交
      stream: form,
      // 明确告诉 HttpClient 以 JSON 格式处理响应 body
      dataType: 'json'
    });
    ctx.body = result.data.files;
    // 响应最终会是类似以下的结果：
    // {
    //   "file": "'use strict';\n\nconst For...."
    // }
  }
}
```

### 以 Stream 方式上传文件

- Stream 实际会以 Transfer-Encoding: chunked 传输编码格式发送
- 转换是 HTTP 模块自动实现的

```js
// app/controller/npm.js
const fs = require('fs');
const FormStream = require('formstream');
class NpmController extends Controller {
  async uploadByStream() {
    const ctx = this.ctx;
    // 上传当前文件本身用于测试
    const fileStream = fs.createReadStream(__filename);
    // httpbin.org 不支持 stream 模式，使用本地 stream 接口代替
    const url = `${ctx.protocol}://${ctx.host}/stream`;
    const result = await ctx.curl(url, {
      // 必须指定 method，支持 POST，PUT
      method: 'POST',
      // 以 stream 模式提交
      stream: fileStream
    });
    ctx.status = result.status;
    ctx.set(result.headers);
    ctx.body = result.data;
    // 响应最终会是类似以下的结果：
    // {"streamSize":574}
  }
}
```

## options 参数详解
