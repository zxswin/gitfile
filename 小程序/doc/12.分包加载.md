# 分包加载

## 关于分包加载

- 关于分包加载

```bash
整个小程序所有分包大小不超过 8M
单个分包/主包大小不能超过 2M
对小程序进行分包，可以优化小程序首次启动的下载时间
```

- 打包及应用规则

```bash
## 打包原则
声明 subpackages 后，将按 subpackages 配置路径进行打包，subpackages 配置路径外的目录将被打包到 app（主包） 中
app（主包）也可以有自己的 pages（即最外层的 pages 字段）
subpackage 的根目录不能是另外一个 subpackage 内的子目录
tabBar 页面必须在 app（主包）内

## 引用原则
packageA 无法 require packageB JS 文件，但可以 require app、自己 package 内的 JS 文件
packageA 无法 import packageB 的 template，但可以 require app、自己 package 内的 template
packageA 无法使用 packageB 的资源，但可以使用 app、自己 package 内的资源
```

- 普通分包的配置实例

```bash
## 在app.json 文件中
{
  "pages":[
    "pages/index",
    "pages/logs"
  ],
  "subpackages": [
    {
      "root": "packageA",
      "pages": [
        "pages/cat",
        "pages/dog"
      ]
    }, {
      "root": "packageB",
      "name": "pack2",
      "pages": [
        "pages/apple",
        "pages/banana"
      ]
    }
  ]
}

## subpackages 中，每个分包的配置
root	分包根目录
name  分包别名，分包预下载时可以使用
pages	分包页面路径，相对与分包根目录
independent	分包是否是独立分包
```

## 关于独立分包

- 独立分包

```bash
## 从独立分包中页面进入小程序时，不需要下载主包
## 一个小程序中可以有多个独立分包
## 在app.json的subpackages字段中对应的分包配置项中定义independent字段声明对应分包为独立分包
```

- 独立分包的限制

```bash
## 独立分包中不能依赖主包和其他分包中的内容，包括js文件、template、wxss、自定义组件、插件等。
## 主包中的app.wxss对独立分包无效，应避免在独立分包页面中使用 app.wxss 中的样式；
## App 只能在主包内定义，独立分包中不能定义 App，会造成无法预期的行为；
## 独立分包中暂时不支持使用插件。

## 开发者无法通过 App 对象实现独立分包和小程序其他部分的全局变量共享
## getApp支持 [allowDefault]参数，在 App 未定义时返回一个默认实现。
## 当主包加载，App 被注册时，默认实现中定义的属性会被覆盖合并到真正的 App 中。

## 独立分包中
const app = getApp({allowDefault: true}) // {}
app.data = 456
app.global = {}

## app.js 中
App({
  data: 123,
  other: 'hello'
})

console.log(getApp()) // {global: {}, data: 456, other: 'hello'}
```

- 独立分包的生命周期

```bash
## 由于独立分包中无法定义 App，小程序生命周期的监听可以使用 wx.onAppShow，wx.onAppHide 完成。
## App 上的其他事件可以使用 wx.onError，wx.onPageNotFound 监听
## 在低于6.7.2版本的微信中运行时，独立分包视为普通分包处理，不具备独立运行的特性
```

- 独立分包的配置示例

```bash
## app.json的subpackages字段中对应的分包配置项中定义independent字段声明对应分包为独立分包
{
  "pages": [
    "pages/index",
    "pages/logs"
  ],
  "subpackages": [
    {
      "root": "moduleA",
      "pages": [
        "pages/rabbit",
        "pages/squirrel"
      ]
    }, {
      "root": "moduleB",
      "pages": [
        "pages/pear",
        "pages/pineapple"
      ],
      "independent": true
    }
  ]
}
```

## 分包预下载

- 分包预下载规则

```bash
## 在进入小程序某个页面时，由框架自动预下载可能需要的分包
## 对于独立分包，也可以预下载主包

## 限制
同一个分包中的页面享有共同的预下载大小限额 2M，限额会在工具中打包时校验。
如，页面 A 和 B 都在同一个分包中，A 中预下载总大小 0.5M 的分包，B中最多只能预下载总大小 1.5M 的分包。

```

- 分包预加载配置

```bash
## 配置方法
{
  "pages": ["pages/index"],
  "subpackages": [
    {
      "root": "important",
      "pages": ["index"],
    },
    {
      "root": "sub1",
      "pages": ["index"],
    },
    {
      "name": "hello",
      "root": "path/to",
      "pages": ["index"]
    },
    {
      "root": "sub3",
      "pages": ["index"]
    },
    {
      "root": "indep",
      "pages": ["index"],
      "independent": true
    }
  ],
  "preloadRule": {
    "pages/index": {
      "network": "all",
      "packages": ["important"]
    },
    "sub1/index": {
      "packages": ["hello", "sub3"]
    },
    "sub3/index": {
      "packages": ["path/to"]
    },
    "indep/index": {
      "packages": ["__APP__"]
    }
  }
}

## preloadRule 中，key 是页面路径，value 是进入此页面的预下载配置
## packages
进入页面后预下载分包的 root 或 name。__APP__ 表示主包。
## network
在指定网络下预下载，可选值为：
all: 不限网络
wifi: 仅wifi下预下载
```

## 项目实战中的分包配置

```bash
## 每个使用分包小程序必定含有一个主包。所谓的主包，即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源
## 在小程序启动时，默认会下载主包并启动主包内页面，当用户进入分包内某个页面时，客户端会把对应分包下载下来，下载完成后再进行展示。

## 目前小程序分包大小有以下限制：
整个小程序所有分包大小不超过 8M
单个分包/主包大小不能超过 2M

## TabBar页面不能使用分包,必须包含在主包中

## index.wxml
<navigator url="../../subpages/cat/cat">跳转到分包页面</navigator>
<button class="btn" type="primary" bindtap="onTap">跳转到分包页面</button>
<navigator url="../lists/lists" open-type="switchTab">跳转到tab页面</navigator>
<navigator url="../../indepages/pear/pear">跳转独立分包页面</navigator>

## index.ts
wx.navigateTo({
  url: "../../subpages/cat/cat",
  success: function() {
    console.log("成功后的回调");
  },
  fail: function() {
    console.log("失败后的回调");
  },
  complete: function() {
    console.log("结束后的回调(成功，失败都会执行)");
  }
});

## app.json配置文件
"pages": ["pages/index/index", "pages/lists/lists", "pages/detail/detail"],
"subpackages": [
  {
    "root": "subpages",
    "name": "packA",
    "pages": ["cat/cat"]
  },
  {
    "root": "indepages",
    "name": "packB",
    "pages": ["pear/pear"],
    "independent": true
  }
],
" ": {
  "pages/index/index": {
    "network": "all",
    "packages": ["packA", "packB"]
  }
},

```
