## 自定义组件

- 创建一个简单的自定义组件

```bash
## 在组件wxss中不应使用ID选择器、属性选择器和标签名选择器

组件目录如下：
component
    -|component1
        -|index.ts
        -|index.json
        -|index.wxml
        -|index.wxss

1.一个自定义组件由 json wxml wxss js 4个文件组成。
2.index.json 文件中将 component 字段设为 true 可将这一组文件设为自定义组件
{
  "component": true
}

3.index.ts
Component({
  properties: {
    // 这里定义了innerText属性，属性值可以在组件使用时指定
    innerText: {
      type: String,
      value: "default value888999"
    }
  },
  data: {
    // 这里是一些组件内部数据
    someData: {}
  },
  methods: {
    // 这里是一个自定义方法
    customMethod: function() {}
  }
});

4.index.wxml
<!-- 这是自定义组件的内部WXML结构 -->
<view class="inner">{{innerText}}</view>
<slot></slot>

5.index.wxss
/* 这里的样式只应用于这个自定义组件 */
.inner {
  color: red;
}

# 可以再使用组件的json文件中或者app.json文件中配置
"usingComponents": {
  "component-tag-name": "/pages/component/component1/index"
}

# 在其他页面中使用组件
<!-- index.wxml -->
<view>
	<!-- 以下是对一个自定义组件的引用 -->
	<component-tag-name inner-text="Some text8888"></component-tag-name>
</view>

```

- 组件间通信与事件

```bash
# 在自定义组件中
<!-- index.wxml -->
<button bindtap="onTap">点击这个按钮将触发“myevent”事件</button>

<!-- index.ts -->
onTap: function() {
  const myEventDetail = {
    a: 1
  }; // detail对象，提供给事件监听函数
  this.triggerEvent("myevent", myEventDetail);
}


# 使用自定义组件绑定触发myevent事件时候执行的函数bind:myevent="onMyEvent"
<!-- index.wxml -->
<view>
    <!-- 以下是对一个自定义组件的引用 -->
    <component-tag-name inner-text="Some text8888" bind:myevent="onMyEvent"></component-tag-name>
</view>

<!-- index.ts -->
onMyEvent(e: any) {
  console.log("触发了myevent方法", e.detail);
}
```

- 组件生命周期

```bash
# 组件的生命周期
created	 在组件实例刚刚被创建时执行
attached 在组件实例进入页面节点树时执行
ready 在组件在视图层布局完成后执行
moved 在组件实例被移动到节点树另一个位置时执行
detached 在组件实例被从页面节点树移除时执行
error	Object 每当组件方法抛出错误时执行

# 组件所在页面的生命周期
show 组件所在的页面被展示时执行
hide 组件所在的页面被隐藏时执行
resize 组件所在的页面尺寸变化时执行

Component({
  lifetimes: {
    attached: function() {
      // 在组件实例进入页面节点树时执行
    },
    detached: function() {
      // 在组件实例被从页面节点树移除时执行
    },
  },
  pageLifetimes: {
    show: function() {
      // 页面被展示
    },
    hide: function() {
      // 页面被隐藏
    },
    resize: function(size) {
      // 页面尺寸变化
    }
  }
})
```

- behaviors 是用于组件间代码共享的特性

```bash
## 用于组件间的代码共享
## 字段的覆盖和组合规则
同名的属性或方法，组件本身的属性或方法会覆盖 behavior 中的属性或方法
生命周期函数不会相互覆盖

// my-component.js
var myBehavior = require('my-behavior')
Component({
  behaviors: [myBehavior],
  properties: {
    myProperty: {
      type: String
    }
  },
  data: {
    myData: {}
  },
  attached: function(){},
  methods: {
    myMethod: function(){}
  }
})
```

- 数据监听器

```bash
## 简单的数据监控
## 执行this.setDate方法的时候会触发对应的方法
## 数据监听器和属性的 observer 相比，数据监听器更强大且通常具有更好的性能
observers: {
  'numberA, numberB': function(numberA, numberB) {
    // 在 numberA 或者 numberB 被设置时，执行这个函数
    this.setData({
      sum: numberA + numberB
    })
  }
}

## 数据监听器支持监听属性或内部数据的变化
observers: {
  'some.subfield': function(subfield) {
    // 使用 setData 设置 this.data.some.subfield 时触发
    // （除此以外，使用 setData 设置 this.data.some 也会触发）
    subfield === this.data.some.subfield
  },
  'arr[12]': function(arr12) {
    // 使用 setData 设置 this.data.arr[12] 时触发
    // （除此以外，使用 setData 设置 this.data.arr 也会触发）
    arr12 === this.data.arr[12]
  },
}

## 需要监听所有子数据字段的变化，可以使用通配符 **
observers: {
  'some.field.**': function(field) {
    // 使用 setData 设置 this.data.some.field 本身或其下任何子数据字段时触发
    // （除此以外，使用 setData 设置 this.data.some 也会触发）
    field === this.data.some.field
  },
}

## 仅使用通配符 ** 可以监听全部 setData
observers: {
  '**': function() {
    // 每次 setData 都触发
  },
},
```

- 纯数据字段

```bash
## 不参与界面渲染的 data 字段
## 指定“纯数据字段”的方法是在 Component 构造器的 options 定义段中指定
## 纯数据字段不会被应用到 WXML 上
options: {
  pureDataPattern: /^_/ // 指定所有 _ 开头的数据字段为纯数据字段
},
data: {
  a: true, // 普通数据字段
  _b: true, // 纯数据字段
},
methods: {
  myMethod() {
    this.data._b // 纯数据字段可以在 this.data 中获取
    this.setData({
      c: true, // 普通数据字段
      _d: true, // 纯数据字段
    })
  }
}
```

- 自定义组件拓展

```bash
## 自定义组件的扩展其实就是提供了修改自定义组件定义段的能力
// behavior.js
module.exports = Behavior({
  definitionFilter(defFields) {
    defFields.data.from = 'behavior'
  },
})

// component.js
Component({
  data: {
    from: 'component'
  },
  behaviors: [require('behavior.js')],
  ready() {
    console.log(this.data.from) // 此处会发现输出 behavior 而不是 component
  }
})
```
